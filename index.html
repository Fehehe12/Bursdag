<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bursdag! ðŸŽ‰</title>
  <style>
    :root{ --bpm:122; }
    html,body{ height:100%; margin:0; background:#000; overflow:hidden; }
    body{ font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:#fff; }

    /* Fullskjerms YouTube bakgrunn */
    .video-bg{ position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
    .video-bg iframe{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      width:177.78vh; height:100vh; min-width:100vw; min-height:56.25vw;
    }

    /* Lydknapp (nettleserkrav) */
    #soundBtn{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      padding:12px 18px; border:0; border-radius:999px; cursor:pointer; z-index:10;
      background:rgba(255,255,255,0.92); color:#111; box-shadow:0 10px 30px rgba(0,0,0,.25); font-weight:700;
    }
    #soundBtn.hide{ opacity:0; transform:translate(-50%, 10px); pointer-events:none; transition:all .28s ease; }

    /* Skjerm-auralayer og flash */
    #aura{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.98);
      width:64vmin; height:64vmin; border-radius:22px; pointer-events:none; z-index:2;
      opacity:0; filter:blur(28px) saturate(1.8) brightness(1.1); mix-blend-mode:screen;
      background:
        radial-gradient(closest-side, rgba(0,255,213,.5), transparent 70%),
        conic-gradient(
          from 0deg,
          rgba(0,255,213,.0), rgba(0,255,213,.75),
          rgba(255,0,153,.75), rgba(255,255,0,.75),
          rgba(0,255,213,.75), rgba(0,255,213,.0)
        );
      transition:opacity .4s ease;
    }
    .colorburst-on #aura{ opacity:.85; }
    #aura.boom{ animation: auraBoom 320ms ease-out; }
    @keyframes auraBoom{
      0%  { transform:translate(-50%,-50%) scale(.98); opacity:.95; }
      60% { transform:translate(-50%,-50%) scale(1.06); opacity:.95; }
      100%{ transform:translate(-50%,-50%) scale(1.00); opacity:.80; }
    }
    #flash{ position:fixed; inset:0; background:white; opacity:0; z-index:5; pointer-events:none; }
    #flash.pop{ animation: flashPop 380ms ease-out; }
    @keyframes flashPop{ 0%{ opacity:.9; } 100%{ opacity:0; } }

    /* 3-2-1 countdown */
    #countdown{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      font:900 clamp(48px,16vw,220px)/1 system-ui; color:#fff; z-index:7; mix-blend-mode:screen;
      text-shadow:0 0 20px #fff, 0 0 60px #f0f, 0 0 90px #ff0;
      opacity:0; pointer-events:none; transition:opacity .25s ease;
    }
    #countdown.show{ opacity:1; }

    /* HERO SHELL: flyt/skalering fÃ¸r dropp, dip ved dropp */
    #heroShell{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%) scale(0.18);
      z-index:4;
      transition: left .6s ease-in, top .6s ease-in, transform 0.12s ease-out;
      will-change: left, top, transform;
    }

    /* Kortet (klipp, neon, beats) */
    #hero{
      position:relative; width:50vmin; height:50vmin; border-radius:16px; overflow:hidden;
      transition: box-shadow 0.18s ease-out, filter 0.18s ease-out;
      will-change: box-shadow, filter, transform;
    }
    #hero img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; }
    /* VIKTIG: melt-laget over det skarpe, sÃ¥ du faktisk ser smelteeffekten */
    #heroSharp{ z-index:1; }
    #heroMelt { z-index:2; opacity:0; filter:url(#melt); transition:opacity .6s ease; }
    .melt-on #heroMelt{ opacity:0.5; } /* moderat, personen er fortsatt tydelig */

    /* Neon inni kortet */
    #neon{
      position:absolute; inset:-12%; border-radius:inherit; pointer-events:none;
      mix-blend-mode:screen; opacity:0;
      background:
        radial-gradient(35% 35% at 20% 30%, rgba(0,255,213,0.65), transparent 60%),
        radial-gradient(30% 30% at 80% 25%, rgba(255,0,153,0.60), transparent 60%),
        radial-gradient(28% 28% at 50% 80%, rgba(255,255,0,0.55), transparent 60%),
        conic-gradient(from 0deg at 50% 50%, rgba(0,255,255,0.25), rgba(255,0,255,0.25), rgba(255,255,0,0.25), rgba(0,255,255,0.25));
      filter: blur(22px) saturate(1.9) brightness(1.2);
      transition:filter 160ms ease;
    }
    .neon-active #neon{
      opacity:1; animation: neonFlow 5.2s linear infinite, neonHue 6.5s linear infinite;
    }
    @keyframes neonFlow{
      0%{   background-position: 0% 0%, 100% 0%, 50% 100%, 50% 50%; }
      25%{  background-position: 50% 50%, 50% 100%, 0% 50%, 50% 50%; }
      50%{  background-position: 100% 0%, 0% 100%, 50% 0%, 50% 50%; }
      75%{  background-position: 50% 50%, 100% 50%, 100% 100%, 50% 50%; }
      100%{ background-position: 0% 0%, 100% 0%, 50% 100%, 50% 50%; }
    }
    @keyframes neonHue{
      0%{   filter: hue-rotate(0deg)   blur(22px) saturate(1.9) brightness(1.2); }
      100%{ filter: hue-rotate(360deg) blur(22px) saturate(1.9) brightness(1.2); }
    }

    /* Indre aura langs kantene pÃ¥ beat */
    #hero::before{
      content:""; position:absolute; inset:-10px; border-radius:inherit; pointer-events:none; opacity:0;
      background:
        conic-gradient(
          from 0deg,
          rgba(0,255,213,0) 0deg,
          rgba(0,255,213,.95) 40deg,
          rgba(255,0,153,.95) 120deg,
          rgba(255,255,0,.95) 220deg,
          rgba(0,255,213,.95) 320deg,
          rgba(0,255,213,0) 360deg
        );
      mix-blend-mode:screen; filter:blur(14px) saturate(1.8);
      transform:scale(1);
    }

    /* Beat-variant 1: myk bassy bounce etter Drop1 */
    #hero.beat1{
      box-shadow:
        0 0 42px 14px rgba(255,255,255,0.72),
        0 0 80px rgba(255,0,0,0.25),
        0 0 110px rgba(255,255,0,0.18);
      animation:bass1 160ms ease-out;
      filter:saturate(1.10) contrast(1.04);
    }
    #hero.beat1::before{ opacity:1; animation: innerAura1 280ms ease-out; }
    @keyframes bass1{
      0%  { transform: translate(0,0) scale(1.02) rotate(-0.25deg); }
      45% { transform: translate(2px,-1px) scale(1.055) rotate(0.35deg); }
      100%{ transform: translate(0,0) scale(1.015) rotate(0deg); }
    }
    @keyframes innerAura1{
      from{ transform:scale(1);   opacity:1; }
      to  { transform:scale(1.08); opacity:0; }
    }

    /* Beat-variant 2: hardere overdrive etter Drop2 */
    body.drop2-mode #neon{ filter: blur(28px) saturate(2.4) brightness(1.45); }
    body.drop2-mode #aura{ width:72vmin; height:72vmin; filter:blur(34px) saturate(2.0) brightness(1.2); }
    #hero.beat2{
      box-shadow:
        0 0 60px 18px rgba(255,255,255,0.85),
        0 0 120px rgba(255,0,120,0.42),
        0 0 160px rgba(255,255,0,0.30);
      animation:bass2 260ms cubic-bezier(.2,.8,.2,1.25);
      filter:saturate(1.18) contrast(1.07);
    }
    #hero.beat2::before{ opacity:1; animation: innerAura2 340ms ease-out; }
    #hero.beat2::after{
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      border:3px solid rgba(255,255,255,0.85); opacity:1; animation:pulseRing2 300ms ease-out;
    }
    @keyframes bass2{
      0%  { transform: translate(0,0) scale(1.00) rotate(0deg); }
      35% { transform: translate(-3px, 2px) scale(1.12) rotate(-0.6deg); }
      55% { transform: translate( 3px,-2px) scale(1.06) rotate(0.6deg); }
      100%{ transform: translate(0,0) scale(1.02) rotate(0deg); }
    }
    @keyframes innerAura2{
      from{ transform:scale(1);   opacity:1; }
      to  { transform:scale(1.14); opacity:0; }
    }
    @keyframes pulseRing2{
      from{ transform:scale(1);   opacity:.95; }
      to  { transform:scale(1.30); opacity:0; }
    }

    /* Tekst over bildet (forankret til bildet) */
    #dropMsg{
      position:absolute; left:50%; bottom:calc(100% + 12px); transform:translateX(-50%);
      font-weight:900; text-align:center; line-height:1.1; letter-spacing:.5px;
      font-size:clamp(22px, 4.8vw, 54px);
      opacity:0; z-index:6; pointer-events:none;
      color:#fff;
      -webkit-text-stroke: 2px rgba(0,0,0,.55);
      text-shadow:
        0 0 10px rgba(255,255,255,.85),
        0 0 24px rgba(255,0,153,.75),
        0 0 40px rgba(255,255,0,.65),
        0 2px 14px rgba(0,0,0,.65);
      transition:opacity .28s ease;
      white-space:nowrap;
    }
    #dropMsg.show{ opacity:1; }
    #dropMsg.mega{ font-size:clamp(26px, 6.5vw, 68px); -webkit-text-stroke:3px rgba(0,0,0,.6);}
    #dropMsg.blink{
      color:hsl(var(--h,0) 100% 65%);
      filter:brightness(1.25) saturate(1.4);
      animation:msgPulse 220ms ease-out;
    }
    @keyframes msgPulse{ from{ transform:translateX(-50%) scale(1.0); } to{ transform:translateX(-50%) scale(1.06); } }

    /* Partikler */
    #sparks{ position:fixed; inset:0; pointer-events:none; z-index:3; }
    .spark{
      position:fixed; left:50%; top:50%; width:6px; height:6px; border-radius:50%;
      background:white; filter: blur(0.5px);
      mix-blend-mode:screen; opacity:0.95;
      transform: translate(-50%,-50%);
      animation: fly var(--life,600ms) ease-out forwards;
    }
    @keyframes fly{
      0%   { transform: translate(calc(-50% + 0px), calc(-50% + 0px)) scale(1); opacity:1; }
      100% { transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(.8); opacity:0; }
    }
    .confetti{
      position:fixed; width:8px; height:14px; opacity:0.95; z-index:2;
      will-change: transform, opacity;
      animation: confFall linear forwards;
    }
    @keyframes confFall{
      0%   { transform: translate(var(--x), -10vh) rotate(0deg); opacity:1; }
      100% { transform: translate(var(--x), 110vh) rotate(540deg); opacity:0.9; }
    }
  </style>
</head>
<body>

  <!-- Bakgrunnsvideo -->
  <div class="video-bg"><div id="player"></div></div>

  <!-- Skjerm-auralayer og flash -->
  <div id="aura"></div>
  <div id="flash"></div>

  <!-- HERO SHELL (flytter/skalere fÃ¸r dropp) -->
  <div id="heroShell">
    <div id="hero">
      <!-- SMELT OVER SHARP -->
      <img id="heroMelt"  src="kristian.jpg" alt="Bursdagsbarnet" />
      <img id="heroSharp" src="kristian.jpg" alt="Bursdagsbarnet" />
      <div id="neon"></div>
      <div id="dropMsg">GRALLA ME DAGEN HINNA!</div>
    </div>
  </div>

  <div id="sparks"></div>
  <div id="countdown"></div>

  <!-- SVG-filter for smelte-effekt -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <filter id="melt">
        <feTurbulence id="turb" type="fractalNoise" baseFrequency="0.008 0.02" numOctaves="2" seed="7" result="noise"/>
        <feDisplacementMap id="disp" in="SourceGraphic" in2="noise" scale="0" xChannelSelector="R" yChannelSelector="G"/>
      </filter>
    </defs>
  </svg>

  <button id="soundBtn" type="button">Start musikk ðŸ”Š</button>

  <!-- YouTube Iframe API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    /* KONFIG */
    const YT_VIDEO_ID = 'NYVg-V8-7q0';
    const DROP1 = 85.5;    // 1:25.5
    const DROP2 = 180.5;   // 3:00.5
    const BPM   = 122;
    document.documentElement.style.setProperty('--bpm', BPM);

    /* YouTube player */
    let player;
    function onYouTubeIframeAPIReady(){
      player = new YT.Player('player', {
        videoId: YT_VIDEO_ID,
        playerVars: {
          autoplay: 1, controls: 0, mute: 1, start: 0, rel: 0,
          modestbranding: 1, playsinline: 1, loop: 1, playlist: YT_VIDEO_ID
        },
        events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange }
      });
    }
    function onPlayerReady(){
      try{ player.getIframe().setAttribute('allow','autoplay; encrypted-media; picture-in-picture'); }catch(e){}
      player.playVideo(); // mutet â€“ klar bak
      tick();
    }
    function onPlayerStateChange(e){ if(e.data === YT.PlayerState.ENDED) player.playVideo(); }

    /* Lyd-unlock */
    const soundBtn = document.getElementById('soundBtn');
    async function unlockAudio(){
      if(!player || typeof player.playVideo !== 'function') return;
      try{ player.getIframe().setAttribute('allow','autoplay; encrypted-media; picture-in-picture'); }catch(e){}
      const attempts = [
        () => { player.unMute(); player.setVolume(100); player.playVideo(); },
        () => { player.playVideo(); player.unMute(); player.setVolume(100); },
        () => { player.mute(); player.playVideo(); player.unMute(); player.setVolume(100); player.playVideo(); },
      ];
      for(const step of attempts){
        try{ step(); }catch(e){}
        await new Promise(r=>setTimeout(r,150));
        const ok = (player.getPlayerState && player.getPlayerState() === 1) && (player.isMuted ? !player.isMuted() : true);
        if(ok) break;
      }
      soundBtn.classList.add('hide');
      window.removeEventListener('touchstart', unlockAudio);
    }
    soundBtn.addEventListener('click', unlockAudio, { once:true });
    window.addEventListener('touchstart', unlockAudio, { once:true });
    window.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter') unlockAudio(); }, { once:true });

    /* DOM-refs */
    const heroShell = document.getElementById('heroShell');
    const hero      = document.getElementById('hero');
    const aura      = document.getElementById('aura');
    const flash     = document.getElementById('flash');
    const sparks    = document.getElementById('sparks');
    const dropMsg   = document.getElementById('dropMsg');
    const turb      = document.getElementById('turb');
    const disp      = document.getElementById('disp');
    const countdown = document.getElementById('countdown');

    /* State */
    const beatInterval = 60 / BPM;
    let lastBeat = 0;
    let meltOn = false, meltStart = 0, beatPulse = 0;
    let stage = 0; // 0: pre-DROP1, 1: mellom, 2: etter DROP2
    let drop2Armed = false;
    let hue = 0;
    let countdownArmed = false;
    let msgTimer = null;

    const lerp = (a,b,t)=> a + (b - a) * t;

    function spawnSparks(n = 10, spread = 120){
      for(let i=0;i<n;i++){
        const s = document.createElement('div');
        s.className = 'spark';
        const ang = Math.random() * Math.PI * 2;
        const dist = 50 + Math.random()*spread;
        const dx = Math.cos(ang) * dist;
        const dy = Math.sin(ang) * dist;
        s.style.setProperty('--dx', dx.toFixed(1)+'px');
        s.style.setProperty('--dy', dy.toFixed(1)+'px');
        s.style.setProperty('--life', (450 + Math.random()*400)+'ms');
        const h = Math.floor(Math.random()*360);
        s.style.background = `hsl(${h} 100% 70%)`;
        s.style.boxShadow = `
          0 0 12px hsl(${h} 100% 70% / .95),
          0 0 24px hsl(${(h+300)%360} 100% 60% / .75),
          0 0 36px hsl(${(h+60)%360} 100% 55% / .65)
        `;
        sparks.appendChild(s);
        s.addEventListener('animationend', ()=> s.remove());
      }
    }
    function spawnConfetti(rows = 20){
      const W = window.innerWidth;
      for(let i=0;i<rows;i++){
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.setProperty('--x', (Math.random()*W)+'px');
        const h = Math.floor(Math.random()*360);
        c.style.background = `hsl(${h} 95% 55%)`;
        c.style.left = '0';
        c.style.top = '0';
        c.style.animationDuration = (1200 + Math.random()*1400)+'ms';
        c.style.animationDelay = (Math.random()*250)+'ms';
        document.body.appendChild(c);
        c.addEventListener('animationend', ()=> c.remove());
      }
    }
    function screenFlash(){
      flash.classList.remove('pop'); void flash.offsetWidth; flash.classList.add('pop');
    }

    /* 3-2-1 countdown fÃ¸r DROP1 */
    function armCountdown(){
      if(countdownArmed) return;
      countdownArmed = true;
      const show = (n) => {
        countdown.textContent = n;
        countdown.classList.add('show');
        setTimeout(()=> countdown.classList.remove('show'), 680);
      };
      show(3);
      setTimeout(()=>show(2), 1000);
      setTimeout(()=>show(1), 2000);
    }

    /* Beat trigger â€“ to varianter */
    function triggerBeat(){
      hue = (hue + 37) % 360;
      dropMsg.style.setProperty('--h', hue);
      dropMsg.classList.remove('blink'); void dropMsg.offsetWidth; dropMsg.classList.add('blink');

      aura.classList.remove('boom'); void aura.offsetWidth; aura.classList.add('boom');
      spawnSparks(stage === 2 ? 16 : 10, stage === 2 ? 190 : 140);

      // gi melt et ekstra â€œpunchâ€ pr beat
      beatPulse += (stage === 2 ? 9 : 6);

      if(stage === 1){
        hero.classList.remove('beat1'); void hero.offsetWidth; hero.classList.add('beat1');
      } else if(stage === 2){
        hero.classList.remove('beat2'); void hero.offsetWidth; hero.classList.add('beat2');
      }
    }

    /* Liten â€œdipâ€ ved dropp 1 */
    function dipHeroShell(){
      heroShell.style.transform = 'translate(-50%, calc(-50% + 18px)) scale(1)';
      setTimeout(()=>{ heroShell.style.transform = 'translate(-50%,-50%) scale(1)'; }, 280);
    }

    /* Vis/skjul drop-tekst (brukes pÃ¥ dropp 1 og 2) */
    function showDropMsg({mega=false, duration=5000} = {}){
      if(mega) dropMsg.classList.add('mega'); else dropMsg.classList.remove('mega');
      dropMsg.classList.add('show');
      if(msgTimer) clearTimeout(msgTimer);
      msgTimer = setTimeout(()=> dropMsg.classList.remove('show'), duration);
    }

    function tick(){
      if(!player || typeof player.getCurrentTime !== 'function'){ return requestAnimationFrame(tick); }
      const t = player.getCurrentTime();

      /* Countdown: armer nÃ¥r vi nÃ¦rmer oss DROP1 */
      if(!countdownArmed && t >= (DROP1 - 3.05) && t < DROP1){ armCountdown(); }

      if(t < DROP1){
        stage = 0;
        // Flyt rundt skjermen + myk skalering
        const W = window.innerWidth, H = window.innerHeight, S = Math.min(W,H);
        const ampX = 0.28 * S, ampY = 0.20 * S;
        const x = W/2 + Math.cos(t * 0.60) * ampX;
        const y = H/2 + Math.sin(t * 0.85) * ampY;
        heroShell.style.left = x.toFixed(1) + 'px';
        heroShell.style.top  = y.toFixed(1) + 'px';
        const scale = Math.max(0.18, 0.98 * Math.min(1, t / DROP1));
        heroShell.style.transform = `translate(-50%,-50%) scale(${scale.toFixed(3)})`;
        hero.classList.remove('beat1','beat2');

      } else {
        // Etter DROP1
        if(stage === 0){
          stage = 1;
          heroShell.style.left = '50%';
          heroShell.style.top  = '50%';
          heroShell.style.transform = 'translate(-50%,-50%) scale(1)';
          dipHeroShell();

          if(!hero.classList.contains('neon-active')) hero.classList.add('neon-active');
          if(!meltOn){
            meltOn = true; meltStart = performance.now()/1000;
            hero.classList.add('melt-on');               // SMELT PÃ… DROPP 1
            document.body.classList.add('colorburst-on');
            aura.classList.add('boom');
            spawnSparks(16, 160);
            screenFlash();
            showDropMsg({ mega:false, duration:4500 });  // vis tekst (drop 1), skjul etter litt
          }
        }

        // Beat-synk og trigger
        if(lastBeat === 0){ lastBeat = t; hero.classList.remove('beat1','beat2'); }
        if(t - lastBeat >= (beatInterval)){
          const skips = Math.max(1, Math.floor((t - lastBeat) / beatInterval));
          lastBeat += beatInterval * skips;
          triggerBeat();
        }

        // DROP 2: skru opp alt + vis teksten igjen (â€œmegaâ€)
        if(t >= DROP2 && !drop2Armed){
          drop2Armed = true;
          stage = 2;
          document.body.classList.add('drop2-mode');
          for(let i=0;i<3;i++){ aura.classList.remove('boom'); void aura.offsetWidth; aura.classList.add('boom'); }
          screenFlash();
          spawnSparks(32, 240);
          spawnConfetti(36);
          const meltLayer = document.getElementById('heroMelt');
          if(meltLayer) meltLayer.style.opacity = '0.6';
          showDropMsg({ mega:true, duration:6000 });     // VIS IGJEN PÃ… DROPP 2
        }
      }

      // Smelte-animasjon (tydelig + beat-koblet)
      if(meltOn){
        const now = performance.now()/1000;
        const dt  = Math.max(0, now - meltStart);
        // Grunnstyrke + beatPulse gir dynamikk
        const baseScale = Math.min(stage === 2 ? 26 : 20, dt * (stage === 2 ? 10 : 8));
        beatPulse *= 0.90;
        const wiggle = (stage === 2 ? 4.5 : 3.5) * Math.sin((t - DROP1) * 2.0);
        const scale  = Math.max(0, baseScale + beatPulse + wiggle);
        disp.setAttribute('scale', scale.toFixed(1));
        const fx = 0.008 + 0.004 * (0.5 + 0.5 * Math.sin((t - DROP1) * 0.9));
        const fy = 0.020 + 0.006 * (0.5 + 0.5 * Math.cos((t - DROP1) * 1.1));
        turb.setAttribute('baseFrequency', fx.toFixed(4) + ' ' + fy.toFixed(4));
      }

      requestAnimationFrame(tick);
    }
  </script>
</body>
</html>
